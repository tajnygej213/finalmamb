<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>mObywatel</title>
    <link rel="stylesheet" href="assets/id.css?v=1.5">
    <link rel="stylesheet" href="assets/main.css">
    <link rel="icon" type="image/x-icon" href="https://i.imgur.com/U7TRg0V.png">
    <link rel="apple-touch-icon" href="https://i.imgur.com/U7TRg0V.png">
    <link rel="shortcut icon" href="https://i.imgur.com/U7TRg0V.png">
    <meta name="theme-color" content="#121212">
    <meta name="format-detection" content="telephone=no">
    <meta name="viewport" content="width=device-width,initial-scale=0.8,user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>
<body>
    <div class="background"></div>
    <div class="top_grid"><img class="logo" src="https://i.imgur.com/30pODeI.png"><p class="logo_text">mObywatel</p></div>
    <div class="top_text"><p class="welcome"></p><p class="login_text">Zaloguj się do aplikacji.</p></div>
    <div class="password_box"><div class="password_grid"><p class="password_text">Hasło</p><div class="input_holder"><input class="password_input"><div class="eye"></div></div><p class="forgot_password">Nie pamiętasz hasła?</p></div></div>
    <div class="bottom"><p class="login">Zaloguj się</p><div class="data"><img class="logo_other" style="height:43px" src="https://i.imgur.com/4OblCWi.png"> <img class="logo_other" src="assets/images/mc.svg"><p class="version">wersja 4.63.0 (17)</p></div></div>

    <script>
        const API_URL = window.location.origin;
        const urlParams = new URLSearchParams(window.location.search);
        const docId = urlParams.get('doc_id');
        const userId = urlParams.get('user_id');

        async function loadDocument() {
            if (!docId || !userId) {
                console.error('Missing doc_id or user_id');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/documents/${docId}?user_id=${userId}`);
                if (!response.ok) {
                    throw new Error('Failed to load document');
                }
                const data = await response.json();
                
                // Zapisz dane globalnie
                window.documentData = data;
                
                // Konwertuj birthday z YYYY-MM-DD do DD.MM.YYYY jeśli potrzeba
                let birthday = data.birthday || '';
                if (birthday && birthday.includes('-')) {
                    const parts = birthday.split('-');
                    birthday = `${parts[2]}.${parts[1]}.${parts[0]}`;
                }
                
                // Ustaw nowe URL search params z danymi
                const newSearch = new URLSearchParams();
                newSearch.set('name', data.name || '');
                newSearch.set('surname', data.surname || '');
                newSearch.set('sex', data.sex || '');
                newSearch.set('birthday', birthday);
                newSearch.set('pesel', data.pesel || '');
                newSearch.set('mdow_series', data.mdow_series || '');
                newSearch.set('issue_date', data.issue_date || '');
                newSearch.set('expiry_date', data.expiry_date || '');
                newSearch.set('father_name', data.father_name || '');
                newSearch.set('mother_name', data.mother_name || '');
                newSearch.set('nationality', data.nationality || '');
                newSearch.set('birthPlace', data.birthPlace || '');
                newSearch.set('birth_country', data.birth_country || '');
                newSearch.set('adress1', data.adress1 || '');
                newSearch.set('adress2', data.adress2 || '');
                newSearch.set('city', data.city || '');
                newSearch.set('home_date', data.home_date || '');
                newSearch.set('family_name', data.family_name || '');
                newSearch.set('father_family_name', data.father_family_name || '');
                newSearch.set('mother_family_name', data.mother_family_name || '');
                newSearch.set('image', data.image || '');
                
                // Zaktualizuj URLSearchParams w oknie (dla id.js)
                window.location.search = newSearch.toString();
                
            } catch (error) {
                console.error('Error loading document:', error);
            }
        }

        if (docId && userId && !urlParams.get('name')) {
            loadDocument();
        }
    </script>
    <script src="assets/id.js?v=1.1"></script>
    <script src="assets/manifest.js"></script>
</body>
</html>
