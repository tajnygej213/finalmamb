<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="mObywatel">
    <meta name="theme-color" content="#09020e">
    <link rel="manifest" href="/manifest.json">
    <title>mObywatel v4.0 | #COLGATE777</title>
    <script>
        const user_id = localStorage.getItem('user_id');
        if (!user_id) {
            window.location.href = '/login.html';
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        :root{--bg-dark:#09020e;--bg-mid:#1c0a27;--text-light:#eeeeee;--text-subtle:#777777;--glass-fill:rgba(255,255,255,0.05);--border-clear:rgba(150,0,255,0.3);--accent-purple:#9c27b0;--accent-glow:rgba(150,0,255,0.6);--shadow-button:rgba(150,0,255,0.4);--error-red:#ff3333;--success-green:#33ff33;--accent-blue:#3366ff}body{font-family:Inter,sans-serif;background-color:var(--bg-dark);color:var(--text-light);display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;height:100dvh;height:100svh;margin:0;padding:0;box-sizing:border-box;background-image:radial-gradient(circle at top left,var(--bg-mid) 5%,transparent 40%),radial-gradient(circle at bottom right,rgba(150,0,255,0.1) 0,transparent 45%);overflow:hidden;position:relative}.container{background:var(--glass-fill);backdrop-filter:blur(20px) brightness(1.1);-webkit-backdrop-filter:blur(20px) brightness(1.1);padding:30px;border-radius:28px;border:1px solid var(--border-clear);box-shadow:0 10px 40px rgba(0,0,0,0.9),0 0 20px var(--accent-glow) inset;width:100%;max-width:350px;max-height:90vh;max-height:90dvh;overflow-y:auto;-webkit-overflow-scrolling:touch}h1{color:var(--text-light);text-align:center;margin-bottom:30px;font-weight:700;letter-spacing:1.5px;font-size:1.8rem;text-shadow:0 0 10px var(--accent-purple);border-bottom:1px solid var(--border-clear);padding-bottom:18px}.form-group{margin-bottom:20px;position:relative;transition:transform 0.2s ease-out}label{display:block;margin-bottom:8px;font-weight:600;color:var(--text-subtle);font-size:0.85rem;transition:color 0.3s}.form-group:focus-within{transform:translateY(-2px);background-color:rgba(150,0,255,0.05);border-radius:12px}.form-group:focus-within label{color:var(--accent-purple);text-shadow:0 0 8px var(--accent-purple)}input[type="text"],input[type="date"],select{width:100%;padding:16px 14px;border:1px solid var(--border-clear);border-radius:12px;box-sizing:border-box;background-color:rgba(0,0,0,0.5);color:var(--text-light);transition:border-color 0.3s,box-shadow 0.3s;font-size:1rem;-webkit-appearance:none;appearance:none}input[type="text"]:focus,input[type="date"]:focus,select:focus{border-color:var(--accent-purple);outline:none;box-shadow:0 0 0 4px var(--accent-glow);background-color:var(--bg-mid)}::placeholder{color:var(--text-subtle);opacity:0.8}input[type="date"]::-webkit-calendar-picker-indicator{filter:invert(1);cursor:pointer}.autofill-block{margin-top:-10px;margin-bottom:20px;padding:15px;border-radius:12px;background-color:rgba(51,102,255,0.05);border:1px solid rgba(51,102,255,0.2);box-shadow:0 0 10px rgba(51,102,255,0.1)}#autofillButton{width:100%;padding:14px 20px;border:none;border-radius:8px;cursor:pointer;font-size:0.95rem;font-weight:600;transition:all 0.2s ease;margin-top:0;background-color:var(--accent-blue);color:var(--text-light);box-shadow:0 2px 10px rgba(51,102,255,0.4)}#autofillButton:hover:not([disabled]){transform:translateY(-1px);filter:brightness(1.1);box-shadow:0 4px 15px rgba(51,102,255,0.6)}#statusMessageAutofill{text-align:center;margin-top:10px;min-height:18px;font-size:0.8rem;font-weight:500;color:var(--text-subtle)}#generateButton{width:100%;padding:18px 20px;border:none;border-radius:12px;cursor:pointer;font-size:1.1rem;font-weight:700;transition:all 0.2s ease;margin-top:30px;margin-bottom:25px;background-color:var(--accent-purple);color:var(--text-light);text-shadow:0 0 5px rgba(0,0,0,0.5);box-shadow:0 4px 20px var(--shadow-button)}button:disabled{opacity:0.5;cursor:not-allowed;transform:none;box-shadow:none}.divider{border:0;height:1px;background-color:var(--border-clear);margin:30px 0}.footer-dev{text-align:center;padding-top:5px;font-size:0.75rem;color:var(--text-subtle);letter-spacing:0.5px;position:relative;width:100%}.footer-dev span{display:block;color:var(--text-light);font-weight:800;font-size:1.5rem;letter-spacing:2px;text-shadow:0 0 15px rgba(255,255,255,0.8),0 0 20px var(--accent-purple);margin-top:5px}#statusMessage{text-align:center;margin-top:-10px;margin-bottom:20px;min-height:18px;font-size:0.85rem;font-weight:600}.file-upload-wrapper{position:relative;display:block}#fileInput{opacity:0;position:absolute;z-index:-1;width:0.1px;height:0.1px;overflow:hidden}.custom-file-upload{display:block;width:100%;padding:16px 14px;border:1px solid var(--border-clear);border-radius:12px;box-sizing:border-box;background-color:rgba(0,0,0,0.5);color:var(--text-subtle);cursor:pointer;text-align:center;transition:all 0.3s;font-size:1rem;font-weight:500}.custom-file-upload:hover{border-color:var(--accent-purple);box-shadow:0 0 0 4px rgba(150,0,255,0.2)}.image-preview-container{width:100%;height:0;opacity:0;border:1px dashed transparent;border-radius:12px;display:flex;justify-content:center;align-items:center;overflow:hidden;margin-top:0;cursor:pointer;transition:all 0.3s ease-in-out}.image-preview-container.active{height:120px;opacity:1;margin-top:5px;border:1px dashed var(--border-clear)}#imagePreview{max-width:100%;max-height:100%;object-fit:contain;border-radius:8px;display:block}#imagePreviewContainer.active:hover{border-color:var(--accent-purple)}.instruction-details{margin-bottom:25px;border-radius:12px;overflow:hidden;transition:all 0.3s ease;box-shadow:0 0 10px rgba(0,0,0,0.5)}.instruction-details summary{display:flex;justify-content:space-between;align-items:center;padding:15px 20px;cursor:pointer;font-size:1.05rem;font-weight:700;list-style:none;background-color:var(--accent-purple);color:var(--text-light);text-shadow:0 0 5px rgba(0,0,0,0.5);transition:background-color 0.3s,box-shadow 0.3s,transform 0.2s;box-shadow:0 0 15px var(--accent-glow)}.instruction-details summary:hover{transform:translateY(-2px);box-shadow:0 0 25px var(--accent-glow),0 0 5px var(--text-light)}.instruction-details[open] summary{background-color:#6a1b9a;border-bottom-left-radius:0;border-bottom-right-radius:0;box-shadow:0 0 5px var(--accent-glow)}.instruction-details .icon{font-size:1.2rem;margin-left:10px;transition:transform 0.2s ease}.instruction-details[open] .icon{transform:rotate(90deg)}.instruction-content{padding:20px;background-color:var(--bg-mid);border:1px solid var(--border-clear);border-top:none;border-bottom-left-radius:12px;border-bottom-right-radius:12px}.instruction-content p,.instruction-content strong,.instruction-content li{font-size:0.9rem;color:var(--text-light);line-height:1.5;margin-bottom:10px}.instruction-content ol{margin-top:5px;margin-left:20px;padding-left:0}
    </style>
</head>
<body>
    <div class="container">
        <h1>mObywatel v4.0</h1>
        <details class="instruction-details">
            <summary>INSTRUKCJA <span class="icon">â–¶</span></summary>
            <div class="instruction-content">
                <p>Aby aplikacja dziaÅ‚aÅ‚a jak skrÃ³t na pulpicie telefonu (bez paska adresu przeglÄ…darki), postÄ™puj zgodnie z krokami.</p>
                <strong>System iOS (iPhone): ðŸ“±</strong>
                <ol>
                    <li>Upewnij siÄ™, Å¼e uÅ¼ywasz przeglÄ…darki Safari.</li>
                    <li>UzupeÅ‚nij dane i kliknij GENERUJ.</li>
                    <li>Na nowej stronie naciÅ›nij ikonÄ™ UdostÄ™pnij.</li>
                    <li>Wybierz opcjÄ™ Do Ekranu gÅ‚Ã³wnego.</li>
                </ol>
                <strong>System Android: ðŸ¤–</strong>
                <ol>
                    <li>Upewnij siÄ™, Å¼e uÅ¼ywasz przeglÄ…darki Chrome lub Google.</li>
                    <li>UzupeÅ‚nij dane i kliknij GENERUJ.</li>
                    <li>Na nowej stronie naciÅ›nij ikonÄ™ Menu (3 kropki) w prawym gÃ³rnym rogu.</li>
                    <li>Wybierz opcjÄ™ Dodaj do ekranu gÅ‚Ã³wnego.</li>
                </ol>
            </div>
        </details>
        <form id="dataGenerator">
            <div class="form-group">
                <label for="name">ImiÄ™:</label>
                <input type="text" id="name" name="name" placeholder="Jan" required>
            </div>
            <div class="form-group">
                <label for="surname">Nazwisko:</label>
                <input type="text" id="surname" name="surname" placeholder="Kowalski" required>
            </div>
            <div class="form-group">
                <label for="sex">PÅ‚eÄ‡:</label>
                <select id="sex" name="sex" required>
                    <option value="MÄ˜Å»CZYZNA">MÄ˜Å»CZYZNA</option>
                    <option value="KOBIETA">KOBIETA</option>
                </select>
            </div>
            <div class="form-group">
                <label for="birthday">Data Urodzenia:</label>
                <input type="date" id="birthday" name="birthday" required>
            </div>
            <div class="autofill-block">
                <button type="button" id="autofillButton">WypeÅ‚nij Daty Automatycznie</button>
                <div id="statusMessageAutofill"></div> 
            </div>
            <div class="form-group">
                <label for="pesel">Numer PESEL:</label>
                <input type="text" id="pesel" name="pesel" placeholder="11-cyfrowy numer" maxlength="11" pattern="[0-9]{11}" required>
            </div>
            <div class="form-group">
                <label for="mdow_series">Seria i numer mDowodu:</label>
                <input type="text" id="mdow_series" name="mdow_series" placeholder="MWYC XXXXX" required>
            </div>
            <div class="form-group">
                <label for="issue_date">Data wydania mDowodu (DD.MM.RRRR):</label>
                <input type="text" id="issue_date" name="issue_date" placeholder="14.07.2023" maxlength="10" pattern="[0-9]{2}\.[0-9]{2}\.[0-9]{4}" required>
            </div>
            <div class="form-group">
                <label for="expiry_date">Termin waÅ¼noÅ›ci mDowodu (DD.MM.RRRR):</label>
                <input type="text" id="expiry_date" name="expiry_date" placeholder="14.07.2028" maxlength="10" pattern="[0-9]{2}\.[0-9]{2}\.[0-9]{4}" required>
            </div>
            <div class="form-group">
                <label for="father_name">ImiÄ™ ojca:</label>
                <input type="text" id="father_name" name="father_name" placeholder="Maciej" required>
            </div>
            <div class="form-group">
                <label for="mother_name">ImiÄ™ matki:</label>
                <input type="text" id="mother_name" name="mother_name" placeholder="Ewa" required>
            </div>
            <div class="form-group">
                <label for="nationality">Obywatelstwo:</label>
                <input type="text" id="nationality" name="nationality" placeholder="POLSKIE" required>
            </div>
            <div class="form-group">
                <label for="birthPlace">Miejsce Urodzenia:</label>
                <input type="text" id="birthPlace" name="birthPlace" placeholder="Warszawa" required>
            </div>
            <div class="form-group">
                <label for="birth_country">Kraj Urodzenia:</label>
                <input type="text" id="birth_country" name="birth_country" placeholder="Polska" required>
            </div>
            <div class="form-group">
                <label for="adress1">Adres (Ulica i numer):</label>
                <input type="text" id="adress1" name="adress1" placeholder="Chopina 4/56" required>
            </div>
            <div class="form-group">
                <label for="adress2">Kod pocztowy / nr:</label>
                <input type="text" id="adress2" name="adress2" placeholder="42-250">
            </div>
            <div class="form-group">
                <label for="city">Miasto:</label>
                <input type="text" id="city" name="city" placeholder="Warszawa">
            </div>
            <div class="form-group">
                <label for="home_date">Data zameldowania (DD.MM.RRRR):</label>
                <input type="text" id="home_date" name="home_date" placeholder="01.01.2000" maxlength="10" pattern="[0-9]{2}\.[0-9]{2}\.[0-9]{4}" required>
            </div>
            <div class="form-group">
                <label for="family_name">Nazwisko rodowe (Twoje):</label>
                <input type="text" id="family_name" name="family_name" placeholder="Kowalski / PanieÅ„skie">
            </div>
            <div class="form-group">
                <label for="father_family_name">Nazwisko rodowe ojca:</label>
                <input type="text" id="father_family_name" name="father_family_name" placeholder="Kowalski">
            </div>
            <div class="form-group">
                <label for="mother_family_name">Nazwisko rodowe matki:</label>
                <input type="text" id="mother_family_name" name="mother_family_name" placeholder="Nowak">
            </div>
            <div class="divider"></div>
            <div class="form-group">
                <label for="fileInput">ZdjÄ™cie:</label>
                <div class="file-upload-wrapper">
                    <input type="file" id="fileInput" accept="image/jpeg, image/png" required>
                    <label for="fileInput" id="fileLabel" class="custom-file-upload">Wybierz plik...</label>
                    <label for="fileInput" class="image-preview-container" id="imagePreviewContainer">
                        <img id="imagePreview" src="#" alt="PodglÄ…d zdjÄ™cia">
                    </label>
                    <input type="hidden" id="image" name="image" value="">
                </div>
            </div>
            <div id="statusMessage"></div> 
            <button type="submit" id="generateButton">/// GENERUJ ///</button>
            <div class="footer-dev">Made by <span>MAMBA</span></div>
        </form>
    </div>

    <script>
        const CLOUD_NAME = 'dijqrebua';
        const UPLOAD_PRESET = 'eobywatel';
        const API_URL = window.location.origin;
        
        const form = document.getElementById('dataGenerator');
        const fileInput = document.getElementById('fileInput');
        const imageURLInput = document.getElementById('image');
        const fileLabel = document.getElementById('fileLabel');
        const generateButton = document.getElementById('generateButton');
        const statusMessage = document.getElementById('statusMessage');
        const statusMessageAutofill = document.getElementById('statusMessageAutofill');
        const imagePreview = document.getElementById('imagePreview');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const autofillButton = document.getElementById('autofillButton');
        
        const peselInput = document.getElementById('pesel');
        const issueDateInput = document.getElementById('issue_date');
        const expiryDateInput = document.getElementById('expiry_date');
        const homeDateInput = document.getElementById('home_date');
        const birthdayInput = document.getElementById('birthday');
        const manualDateFields = [issueDateInput, expiryDateInput, homeDateInput];
        
        function formatDateForDisplay(date) {
            if (!(date instanceof Date) || isNaN(date)) return '';
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        }
        
        function generateRandomFiveDigits() {
            return Math.floor(10000 + Math.random() * 90000);
        }

        autofillButton.addEventListener('click', function(e) {
            e.preventDefault();
            
            const today = new Date();
            const minDate = new Date(today.getFullYear() - 30, 0, 1);
            const maxDate = new Date(today.getFullYear() - 18, 11, 31);
            const randomBirthday = new Date(minDate.getTime() + Math.random() * (maxDate.getTime() - minDate.getTime()));
            
            birthdayInput.value = randomBirthday.toISOString().split('T')[0];
            
            const issueDate = new Date(today.getFullYear() - 2, 0, 1);
            const expiryDate = new Date(today.getFullYear() + 3, 11, 31);
            
            issueDateInput.value = formatDateForDisplay(issueDate);
            expiryDateInput.value = formatDateForDisplay(expiryDate);
            homeDateInput.value = formatDateForDisplay(today);
            
            let pesel = '';
            for (let i = 0; i < 11; i++) {
                pesel += Math.floor(Math.random() * 10);
            }
            peselInput.value = pesel;
            
            document.getElementById('mdow_series').value = `MWYC ${generateRandomFiveDigits()}`;
            
            statusMessageAutofill.textContent = 'âœ“ Daty wypeÅ‚nione!';
            statusMessageAutofill.style.color = 'var(--success-green)';
            setTimeout(() => {
                statusMessageAutofill.textContent = '';
            }, 3000);
        });

        fileInput.addEventListener('change', function() {
            const file = fileInput.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                imagePreview.src = e.target.result;
                imagePreviewContainer.classList.add('active');
            };
            reader.readAsDataURL(file);

            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', UPLOAD_PRESET);

            statusMessage.textContent = 'UploadujÄ™...';
            statusMessage.style.color = 'var(--text-subtle)';

            fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                imageURLInput.value = data.secure_url;
                statusMessage.textContent = 'âœ“ ZdjÄ™cie uploadeone!';
                statusMessage.style.color = 'var(--success-green)';
                setTimeout(() => {
                    statusMessage.textContent = '';
                }, 2000);
            })
            .catch(error => {
                console.error('Error:', error);
                statusMessage.textContent = 'âœ— BÅ‚Ä…d uploadu!';
                statusMessage.style.color = 'var(--error-red)';
            });
        });

        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!imageURLInput.value) {
                statusMessage.textContent = 'âœ— Musisz wybraÄ‡ zdjÄ™cie!';
                statusMessage.style.color = 'var(--error-red)';
                return;
            }

            const pesel = peselInput.value;
            if (pesel.length !== 11 || !/^\d{11}$/.test(pesel)) {
                statusMessage.textContent = 'âœ— PESEL musi mieÄ‡ 11 cyfr!';
                statusMessage.style.color = 'var(--error-red)';
                return;
            }

            for (let field of manualDateFields) {
                const value = field.value;
                if (!/^\d{2}\.\d{2}\.\d{4}$/.test(value)) {
                    statusMessage.textContent = `âœ— ZÅ‚a data! UÅ¼yj formatu DD.MM.RRRR`;
                    statusMessage.style.color = 'var(--error-red)';
                    return;
                }
            }

            const formData = new FormData(form);
            const data = {
                user_id: localStorage.getItem('user_id'),
                name: formData.get('name'),
                surname: formData.get('surname'),
                sex: formData.get('sex'),
                birthday: formData.get('birthday'),
                pesel: formData.get('pesel'),
                mdow_series: formData.get('mdow_series'),
                issue_date: formData.get('issue_date'),
                expiry_date: formData.get('expiry_date'),
                father_name: formData.get('father_name'),
                mother_name: formData.get('mother_name'),
                nationality: formData.get('nationality'),
                birthPlace: formData.get('birthPlace'),
                birth_country: formData.get('birth_country'),
                adress1: formData.get('adress1'),
                adress2: formData.get('adress2'),
                city: formData.get('city'),
                home_date: formData.get('home_date'),
                family_name: formData.get('family_name'),
                father_family_name: formData.get('father_family_name'),
                mother_family_name: formData.get('mother_family_name'),
                image: imageURLInput.value
            };

            generateButton.disabled = true;
            statusMessage.textContent = 'GenerujÄ™ dokument...';
            statusMessage.style.color = 'var(--text-subtle)';

            try {
                const saveResponse = await fetch(`${API_URL}/api/documents/save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!saveResponse.ok) {
                    throw new Error('Failed to save document');
                }

                const result = await saveResponse.json();
                const docId = result.doc_id;
                const userId = localStorage.getItem('user_id');

                const idUrl = `/id.html?doc_id=${docId}&user_id=${userId}`;
                window.open(idUrl, '_blank');

                statusMessage.textContent = 'âœ“ Dokument wygenerowany!';
                statusMessage.style.color = 'var(--success-green)';
            } catch (error) {
                console.error('Error:', error);
                statusMessage.textContent = 'âœ— BÅ‚Ä…d przy generowaniu!';
                statusMessage.style.color = 'var(--error-red)';
            } finally {
                generateButton.disabled = false;
            }
        });
    </script>
</body>
</html>
